# 病人資源關聯圖 - 功能說明

## 資源篩選動態更新功能

### 功能描述
當用戶在關聯圖中**點擊某個節點**時，右側的**資源篩選面板**會動態更新，只顯示與該節點相關的資源類型。無關的資源篩選項會被完全隱藏。

### 工作流程

#### 1. **選中節點前** 
- 篩選面板顯示所有可用的資源類型
- 常用資源類型預設勾選，其他資源類型不勾選
- 所有複選框都是**啟用狀態**，用戶可以自由選擇

#### 2. **選中節點時**
- 關聯圖會隱藏所有與該節點無關的節點和邊
- 右側**資源篩選面板**自動更新：
  - 🎯 **只顯示**與該節點相關的資源類型
  - 隱藏所有無關的資源類型（完全移除，不佔用空間）
  - 用戶**只能看到該節點擁有的資源**進行篩選
  - 用戶可以在相關資源類型間進行篩選，改變該節點所顯示的資源

#### 3. **取消選中節點時**
- 所有節點和邊恢復可見
- 篩選面板恢復原始狀態：
  - 顯示所有資源類型
  - 常用資源預設勾選
  - 用戶可以再次自由選擇篩選條件

### 使用場景
1. **快速查看特定資源**：點擊診斷節點，立即看到該診斷相關的觀察結果和其他資源
2. **簡化篩選**：自動隱藏無關的資源類型，面板只顯示相關的選項
3. **醫事人員工作流**：快速定位特定患者的特定醫療事件及其相關的所有資源

### 技術實現

#### 主要函數
- `updateFiltersForNode(nodeId, connectedNodeIds)`：當節點被選中時調用
  - 收集連接節點的所有資源類型
  - 動態生成僅包含相關資源類型的篩選面板
  - 所有相關資源預設勾選

- `updateVisibilityForSelectedNode()`：當篩選複選框改變時調用（僅在節點選中狀態下）
  - 根據勾選的篩選項顯示/隱藏連接的節點
  - 不會顯示未勾選的資源類型的節點

- `restoreFullFilters()`：當節點被取消選中時調用
  - 完全恢復 `renderFilters()` 的初始狀態

#### 修復的 Bug
- ✅ **節點顯示 Bug**：選中節點時不再被 `updateVisibility()` 覆蓋，確保只顯示相關節點
- ✅ **篩選項顯示**：無關的篩選項完全隱藏，不再只是禁用

### 相關代碼位置
- [app.js - updateFiltersForNode](./app.js#L639)
- [app.js - updateVisibilityForSelectedNode](./app.js#L687)
- [app.js - restoreFullFilters](./app.js#L681)
- [app.js - selectNode 事件](./app.js#L838)
- [app.js - deselectNode 事件](./app.js#L891)
